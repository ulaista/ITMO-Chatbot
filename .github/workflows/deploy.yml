name: üöÄ –ê–≤—Ç–æ-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üõí Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üñ•Ô∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
            if [ ! -d "/home/${{ secrets.SERVER_USER }}/itmo-chatbot" ]; then
              git clone https://github.com/${{ github.repository }}.git /home/${{ secrets.SERVER_USER }}/itmo-chatbot
            else
              cd /home/${{ secrets.SERVER_USER }}/itmo-chatbot
              git reset --hard
              git pull origin main
            fi
          EOF

      - name: üîë –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
            cd /home/${{ secrets.SERVER_USER }}/itmo-chatbot
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
            echo "SEARCH_API_KEY=${{ secrets.SEARCH_API_KEY }}" >> .env
            echo "SEARCH_ENGINE_ID=${{ secrets.SEARCH_ENGINE_ID }}" >> .env
            echo "DEBUG=False" >> .env
          EOF

      - name: üõ† –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << EOF
            cd /home/${{ secrets.SERVER_USER }}/itmo-chatbot
            docker-compose down
            docker-compose up -d --build
          EOF
