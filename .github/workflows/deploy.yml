name: üöÄ –ê–≤—Ç–æ-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ SSH + HTTPS –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üõí Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–¥–æ—Å—Ç—É–ø–∞
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: üñ•Ô∏è –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ HTTPS
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e

            # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            if [ ! -d "/home/${{ secrets.SERVER_USER }}/itmo-chatbot" ]; then
              mkdir -p /home/${{ secrets.SERVER_USER }}/itmo-chatbot
              git clone https://github.com/${{ github.repository }}.git /home/${{ secrets.SERVER_USER }}/itmo-chatbot
            fi

            cd /home/${{ secrets.SERVER_USER }}/itmo-chatbot

            # –ï—Å–ª–∏ .git –Ω–µ—Ç, —É–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É –∏ –∫–ª–æ–Ω–∏—Ä—É–µ–º –∑–∞–Ω–æ–≤–æ
            if [ ! -d ".git" ]; then
              rm -rf /home/${{ secrets.SERVER_USER }}/itmo-chatbot
              git clone https://github.com/${{ github.repository }}.git /home/${{ secrets.SERVER_USER }}/itmo-chatbot
            else
              git reset --hard
              git pull origin main
            fi
          EOF

      - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            cd /home/${{ secrets.SERVER_USER }}/itmo-chatbot

            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
            echo "SEARCH_API_KEY=${{ secrets.SEARCH_API_KEY }}" >> .env
            echo "SEARCH_ENGINE_ID=${{ secrets.SEARCH_ENGINE_ID }}" >> .env
            echo "DEBUG=False" >> .env
          EOF

      - name: üõ† –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            cd /home/${{ secrets.SERVER_USER }}/itmo-chatbot
            docker-compose down
            docker-compose up -d --build
          EOF
