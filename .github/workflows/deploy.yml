name: üöÄ –ê–≤—Ç–æ-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ SSH + HTTPS –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üõí Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–¥–æ—Å—Ç—É–ø–∞
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: üñ•Ô∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e  # –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

            # ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Docker-Compose, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if ! command -v docker &> /dev/null; then
              echo "üöÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker..."
              sudo apt update && sudo apt install -y docker.io
              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            if ! command -v docker-compose &> /dev/null; then
              echo "üöÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker-Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            # ‚úÖ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            if [ ! -d "/home/${{ secrets.SERVER_USER }}/itmo-chatbot" ]; then
              mkdir -p /home/${{ secrets.SERVER_USER }}/itmo-chatbot
              git clone https://github.com/${{ github.repository }}.git /home/${{ secrets.SERVER_USER }}/itmo-chatbot
            fi

            cd /home/${{ secrets.SERVER_USER }}/itmo-chatbot

            if [ ! -d ".git" ]; then
              rm -rf /home/${{ secrets.SERVER_USER }}/itmo-chatbot
              git clone https://github.com/${{ github.repository }}.git /home/${{ secrets.SERVER_USER }}/itmo-chatbot
            else
              git reset --hard
              git pull origin main
            fi

            # ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ `.env`
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
            echo "SEARCH_API_KEY=${{ secrets.SEARCH_API_KEY }}" >> .env
            echo "SEARCH_ENGINE_ID=${{ secrets.SEARCH_ENGINE_ID }}" >> .env
            echo "DEBUG=False" >> .env

            # ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            docker-compose down
            docker-compose up -d --build
          EOF
